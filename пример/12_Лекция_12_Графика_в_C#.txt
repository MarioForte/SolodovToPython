Лекция 12
Графика в C#

Цель лекции. Ознакомиться с правилами работы с графиками. Научиться загружать готовые картинки, рисовать комбинированные фигуры, менять цвет, шрифт.

Среда позволяет:
загрузить в приложение  готовые картинки и фотографии,
разработать программы, которые выводят графику на поверхность объекта.
В ИСР C# Express позволяет загружать файлы – рисунки, созданные в других программах, например Paint, Corel Draw и др.

12.1. Рисованные изображения
Рисованные изображения отображаются на форме при выполнении программы с помощью различных инструментов. 
Изображение при этом представляет собой комбинацию простейших фигур – графических примитивов (точка, линия, круг или прямоугольник). 
Каждая точка на форме имеет координаты X и Y. Текущая позиция при рисовании определяется горизонтальной (X) и вертикальной (Y) координатами, заданными в пикселях. Координата Х возрастает при перемещении указателя слева на право, а координата Y – при перемещении его сверху вниз (рис.12.1)

Рис. 12.1– Сетка координат

12.2 Объект Graphics
Объект Graphics – это указатель на место, где будут рисоваться примитивы. Пусть мы хотим рисовать в форме Windows. Синтаксис задания ссылки на нее:
Graphics g = Graphics.FromHwnd(this.Handle);
Здесь: Graphics  – тип объекта, g  – имя переменной,
Graphics.FromHwnd(this.Handle) – используемый метод FromHwnd из класса Graphics, который задает ссылку Handle на форму Windows.
В С# инструменты рисования определены в пространстве имен System.Drawing. 
Там находятся классы:
Pen (перо). Объекты пера используются в методах рисования линий и контуров геометрических фигур.
Brush (кисть). Объекты кисти используются в методах заливки областей, ограниченных контурами.
Перо (Pen)
Объекты пера используются в методах рисования линий и графических фигур.
Объекты Pen выбираются из класса Pens (перья). Класс Pens содержит набор объектов для выбора. У них толщина линии (1 пиксель), стиль линии – сплошная. У каждого объекта свой цвет линии, имя которого идентифицирует объект. Такой объект нельзя редактировать, его можно только применять. 
Например, создаем объект myPen, совпадающий с шаблоном:
Pen myPen = Pens.Black;
Объекты  Pen с изменяемыми свойствами создаются из класса Pen (перо). В этом случае для объекта пера можно устанавливать  много свойств. Основные свойства:
Color – цвет линии;
Brush – ссылка на кисть, используемую  в качестве пера ;
Width – толщина линии; 
DashStyle – стиль штриховой линии,   
DotStyle – стиль пунктирной линии
DashDotStyle – штрих пунктир,
DashDotDotStyle - штрих двойной пунктир, 
SolidStyle– стиль непрерывная линия.
Сначала объект myPen можно создать с указанием цвета.
Pen myPen = new Pen(Color.Red);
Затем ему можно изменить свойства:
myPen.DashStyle = System.Drawing.Drawing2D.DashStyle.Solid;
myPen.PenType = System.Drawing.Drawing2D.PenType.SolidColor;
myPen.Width = 2;
Можно задать и красиво пишущее перо, в нем перо это кисть.
Pen myFancyPen = new Pen(myBrush);
Кисть (Brush)
Объекты кисти используются в методах заливки графических фигур. Определены кисти разного типа:
Brush – простая кисть, одноцветная заливка. 
HatchBrush – кисть со штриховой заливкой. 
LinearGradientBrush – кисть с линейной градиентной заливкой, цвет фрагментов фигуры меняется плавно.
PathGradientBrush – кисть с градиентной заливкой, цвет фрагментов фигуры меняется скачкообразно.
Объекты Brush выбираются из класса Brushes, который содержит кисти со сплошной заливкой. Класс Brushes содержит набор объектов для выбора, у которых по умолчанию определен цвет. У каждого объекта выбора имя – это цвет заливки. Например, создаем объект myBrush, совпадающий с шаблоном (рис.12.2):
Brush myBrush = Brushes.Blue;		// Заливка синим 

Рис.12.2 Примеры нарисованных графиков
Объекты HatchBrush выбираются из класса HatchBrushes. Класс HatchBrushes содержит набор объектов для выбора, у которых по умолчанию определены стиль заливки HatchStyle, цвет переднего плана ForeColor и  цвет фона BackColor (задний план). Определены стили заливки: 
сетка (Cross), 
диагональная сетка (DiagonalCross), 
прямая диагональ (ForwardDiagonal), 
обратная диагональ (BackwardDiagonal) и др. 
Например, создаем кисть с заливкой сеткой HatchStyle.Cross:
HatchBrush brush2 = new HatchBrush(HatchStyle.Cross, ForeColor, BackColor) (рис.12.3)
.

 
Рис. 12.3 – Результат заливки прямоугольника
Шрифты и текст
Для вывода на форму текста используется метод DrawString. Рисует заданную текстовую строку в заданном прямоугольнике с помощью определяемых объектов кисти и шрифта, используя атрибуты форматирования заданного формата. Синтаксис метода:
DrawString(S, Font, Brush, RectangleF, StringFormat);
S –текстовая строка для рисования.
Font – шрифт текстовой строки.
Brush – кисть. Определяет цвет и текстуру создаваемого текста.
RectangleF – прямоугольник вывода. 
StringFormat – формат, определяющий атрибуты форматирования, такие как междустрочный интервал и выравнивание, которые применяются к создаваемому тексту.
Возможны способы вызова, отличающиеся друг от друга числом аргументов и способом задания прямоугольника вывода. Формат можно не указывать, будет использован формат по умолчанию.
Font. Это шрифт текстовой строки. Выбирается с помощью методов класса Font. Предоставляет возможность выбора размера и стиля шрифта. Возможны несколько  способов вызова, отличающиеся друг от друга числом аргументов  и способом задания нового шрифта. Например:
font МойШрифт = new  Font("Arial" , 24 , FontStyle.Bold ) ;
или
font Шрифт = new  Font("Arial Narrow" , 14 ) ; // без учета начертания шрифта
RectangleF
Это прямоугольник, в котором рисуется строка текста. Задается двумя способами:
4 координаты - левого верхнего (X1, Y1) и правого нижнего (X2, Y2) углов.
Объект точка с координатами левого верхнего угла (P) и размеры (H - ширина и W –высота прямоугольника).

12.3 Методы рисования
В C# определены методы рисования линий и фигур. Все методы перегружаемые, то есть выполняются по-разному с разными аргументами. 
Рисование с помощью пера Pen
При рисовании можно использовать перо  с разными стилями линий LineStyle. Например, solid (сплошная), Dash (штрих), Dot (пунктир), DashDot (штрих-пунктир), DashDotDot (штрих-пунктир-пунктир). 
DrawLine.
Прямая линия между двумя точками. Синтаксис метода:
g.DrawLine(pen, x[1], y[1], x[2], y[2],);
Здесь 		g – где рисуем,
				DrawLine – метод  рисование линии,
				Pen – перо,
				x[1], y[1], x[2], y[2] – точки границы линии, отмечены точками. 

 Можно рисовать окружности, дуги, сектора, прямоугольники, многоугольники (графические примитивы)
DrawRectangle 
Прямоугольник. Синтаксис метода:
g.DrawRectangle(pen, rect);
Здесь:
g – где рисуем,
DrawRectangle  – метод рисования прямоугольника,
pen – перо,
rect – прямоугольник, свойства которого задаются целыми числами 
rectangle Прямоугольник = new Rectangle(x, y, w, h);.
Здесь: 		x, y – координаты левого верхнего угла,
					w – ширина прямоугольника,
					h – высота прямоугольника.
Возможен вариант задания свойств числами в формате с плавающей точкой
rectangle Прямоугольник = new RectangleL(x, y, w, h) (рис.12.4);

Рис.12.4 – Задание свойств числами в формате с плавающей точкой
DrawEllipse
Эллипс. Синтаксис метода:
g.DrawEllipse(pen, rect);
Здесь: 	g – где рисуем,
				DrawEllipse  – метод рисования эллипса,
				pen – перо,
				rect – прямоугольная область, в которую вписывается эллипс. 


12.4 Методы заливки
В C# определены методы заливки фигур. Все методы перегружаемые, то есть выполняются по-разному с разными аргументами.
В примерах заливка разных фигур осуществляется простой кистью  с Brush.Cyan и кистью HatchBrush с разными стилями заливки DashStyle. 
FillRectangle. 
Закрашивает прямоугольник. Синтаксис метода:
g.FillRectangle (brush, p);
Здесь: 	g – где рисуем,
				FillRectangle  – метод рисования залитого прямоугольника
				brush – кисть,
				p – массив точек.
Получаемый результат зависит от стиля заливки. Рисунок слева использована простая кисть с цветом Cyan. Справа использована кисть, у которой стиль заливки BacwardDiagonal (обратная диагональ), цвет переднего плана черный, фона белый (рис.12.5).  
	
Рис.12.5 – Примеры заливки прямоугольника
FillEllipse. 
Закрашивает эллипс. Синтаксис метода:
g.FillEllipse (brush, rect);
Здесь 		g – где рисуем,
				FillEllipse  – метод рисования залитого эллипса,
				brush – кисть,
				rect – прямоугольная область, в которую вписывается эллипс.
Получаемый результат зависит от стиля заливки. Рисунок слева использована простая кисть с цветом Cyan. Справа использована кисть, у которой стиль заливки DiagonalCross (диагональная сетка), цвет переднего плана черный, фона белый(рис.12.6) 
	
Рис.12.6 Примеры заливки эллипса

12.5 Рисование с помощью примитивов
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;   // рисование
using System.Linq;
using System.Text;
using System.Windows.Forms;

namespace WindowsFormsApplication1
{
public partial class Form1 : Form
{
public Form1()
{
InitializeComponent();
}
// обработчик события рисования на форме
private void Form1_Paint(object sender, PaintEventArgs e)
{
using (Graphics g = e.Graphics) //Создание объекта типа График        
{
  using (Pen pen = new Pen(Color.Red)) //цвет карандаша
  g.DrawLine(pen,0,0,200,100);  //рисование линии                
using (Pen pen = new Pen(Color.Blue))
  g.DrawEllipse(pen, new Rectangle(50, 50, 100, 150)); //эллипс                                     
using (Pen pen = new Pen(Color.Green))
g.DrawRectangle(pen, new Rectangle(150, 150, 120, 100));//прямоугольник
string s="Примитивы";
Font font=new Font("Arial",18,FontStyle.Bold);
SolidBrush brush = new SolidBrush(Color.Black);
float x = 120;
float y = 20;
  g.DrawString(s, font, brush, x, y);  //вывод текста в точку (x,y)
            }
        }
    }
}


12.6 Рисование графика функции
Рассмотрим пример программы, которая на форме Windows при соответствующем выборе из списка рисует два графика: sin(x) и cos(x) с текстовыми заголовками. Форма включает контейнер-список «Выбор графика» и кнопку с надписью «Построить», которая запускает обработчик, выполняющий все операции.
В обработчике выполняются следующие действия:
Вычисляется функция.
Задается ссылка на объект графики.
Выводится текст заголовка.
Рисуются координатные оси. 
Рисуется график функции.

Листинг программы:
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Windows.Forms;
namespace WindowsFormsApplication1                    
{
    public partial class Form1 : Form
    {
public Form1()
        {
  InitializeComponent();
        }
private void button1_Click(object sender, EventArgs e)
        {
int imax = 100;              	//число точек в периоде
int t = 2;                    	//число периодов
int amp = 80;                	//амплитуда
int h = 40;                		//отступ для текста
int x0 = 20;                 	//начала координат
int y0 = h + amp;
double[] f = new double[imax * t + 10];  //массив точек
if (comboBox1.Text == "sin(x)")   если из списка выбрать строку "sin(x)"
{             // Расчет массива точек для графика  "sin(x)"
for (int i = 0; i < imax * t; i++)
                {
  f[i] = Math.Round(amp * Math.Sin(2 * Math.PI / imax * i));
                }
  // Инструменты рисования
Graphics g = Graphics.FromHwnd(this.Handle);  // Где рисуем
Pen pen = Pens.Black;                          // Чем рисуем
// Текст заголовка
g.DrawString("График синусоиды", new Font("Arial", 14), Brushes.Red, 40, 0);       
// Рисуем график "sin(x)"
  g.DrawLine(pen, x0, y0, x0 + imax * t, y0);       //Рисуем ось X
g.DrawLine(pen, x0, y0 - amp, x0, y0 + amp);   //Рисуем ось Y 
g.DrawString("Y", new Font("Arial", 10), Brushes.Black, 10, 20);
g.DrawString("X", new Font("Arial", 10), Brushes.Black, x0 + imax * t, y0);
for (int i = 0; i < imax * t; i++)             //Рисуем график
                {
int f1 = y0 - (int)f[i];               		//Координата Y[i]
int f2 = y0 - (int)f[i + 1];             	//Координата Y[i+1]
g.DrawLine(pen, x0 + i, f1, x0 + i + 1, f2);
                }
            }
else if (comboBox1.Text == "cos(x)")  если из списка выбрать строку "cos(x)"
{              // Расчет массива точек для графика "cos(x)"
for (int i = 0; i < imax * t; i++)
                {
f[i] = Math.Round(amp * Math.Cos(2 * Math.PI / imax * i));
                }
                // Инструменты рисования
Graphics g = Graphics.FromHwnd(this.Handle);  // Где рисуем
Pen pen = Pens.Black;                          // Чем рисуем
                // Текст заголовка
g.DrawString("График косинусоиды", new Font("Arial", 14), Brushes.Blue, 40, 0);       
                // Рисуем график  "cos(x)"
g.DrawLine(pen, x0, y0, x0 + imax * t, y0);    //Рисуем ось X
g.DrawLine(pen, x0, y0 - amp, x0, y0 + amp);   //Рисуем ось Y 
g.DrawString("Y", new Font("Arial", 10), Brushes.Black, 10, 20);
g.DrawString("X", new Font("Arial", 10), Brushes.Black, x0 + imax * t, y0);
for (int i = 0; i < imax * t; i++)             //Рисуем график
                {
int f1 = y0 - (int)f[i];               		//Координата Y[i]
int f2 = y0 - (int)f[i + 1];             	//Координата Y[i+1]
g.DrawLine(pen, x0 + i, f1, x0 + i + 1, f2);
                }
            }
        }
    }
} 
При запуске отображается форма, в которой при выборе типа графика рисуется соответствующий график.

Рис. 12.7 – Пример отображения графика

Пример. Создать программу отображения диаграммы двух функций sin(x) и cos(x) с использованием компонента Chart. 
Проект – WindowsForm приложение. Стиль линий Spline.
Создаем – WindowsForm приложение. В форму заносим компоненты chart1 для отображения диаграммы и button1 для создания стартового обработчика событий.
В окне компонента chart1 в разделе Series определяем коллекцию из двух серий (рис.12.7):
Для 1-й функции  с именем sin(x).
Для 2-й функции с именем cos(x).

Рис.12.8 – а)Стартовая форма;  б) Изменение свойств графиков

using System;
using System.Drawing;
using System.Windows.Forms;
namespace WindowsFormsApplication1
{
    public partial class Form1 : Form
    {
public Form1()
        {
  InitializeComponent();
        }
private void button1_Click(object sender, EventArgs e)
        {
double y = 0;
for (int x = 0; (x <= 19); x++)        //цикл по оси х
            {
y = Math.Sin(Math.PI / 5 * x);     //расчет у 1-го графика
chart1.Series["sin(x)"].Points.AddXY(x, y);
y = Math.Cos(Math.PI / 5 * x);    //расчет у 2-го графика
chart1.Series["cos(x)"].Points.AddXY(x, y);
            }
        }
    }
}
Компонент chat с помощью окна Свойства позволяет менять цветовую гамму и тип графика выбранной серии в коллекции (рис.12.9).

Рис.12.9 – Пример изображения график функций

12.7 Растровая графика
Для растровой графики применяются различные форматы:
Bitmap (bmp), попиксельная графика.
TIFF; GIF; PNG; JPEG
BMP (Bitmap Picture) — формат хранения растровых изображений в виде пикселей. 
С форматом BMP работает огромное количество программ, так как его поддержка интегрирована в операционные системы. 
Файлы формата BMP могут иметь расширения .bmp, .dib и .rle. 
Представляет собой набор пикселей, каждый из которых отображается 3 байтами. В байтах фиксируется интенсивность компонент цветов пикселя R (красный), G (зеленый), B (синий). Это самый точный, но и самый емкий по объему формат.
В формате BMP есть поддержка сжатия по алгоритму RLE, однако теперь существуют форматы с более сильным сжатием, и из-за большого объёма BMP редко используется в Интернете, где для сжатия без потерь используются PNG и более старый GIF.
TIFF (Tagged Image File Format) — формат хранения с использованием тегов. TIFF стал популярным форматом для хранения изображений с большой глубиной цвета. Файлы формата TIFF, как правило, имеют расширение .tiff или .tif.
Имеется возможность сохранять изображение в файле формата TIFF со сжатием и без сжатия. Степени сжатия зависят от особенностей самого сохраняемого изображения, а также от используемого алгоритма. Формат TIFF позволяет использовать следующие алгоритмы сжатия:
RLE, с обнаружением длинных одноцветных фрагментов.
Lempel-Ziv-Welch (LZW), с использованием словарей повторяющихся фраз, как в архиваторах ZIP, архивирование JPEG. 
GIF (Graphics Interchange Format ) — формат для обмена изображениями. Формат GIF способен хранить сжатые данные без потери качества в формате до 256 цветов,  использует LZW-компрессию, что позволяет неплохо сжимать файлы, в которых много однородных заливок (логотипы, надписи, схемы).
Изображение в формате GIF хранится построчно, поддерживается только формат с индексированной палитрой цветов. Стандарт разрабатывался для поддержки 256-цветовой палитры.
Один из цветов в палитре может быть объявлен «прозрачным». В этом случае в программах, которые поддерживают прозрачность GIF (например, большинство современных браузеров) сквозь пиксели, окрашенные «прозрачным» цветом будет виден фон.
Формат GIF допускает чересстрочное хранение данных. При этом строки разбиваются на группы, и меняется порядок хранения строк в файле. При загрузке изображение проявляется постепенно, в несколько проходов. Благодаря этому, имея только часть файла, можно увидеть изображение целиком, но с меньшим разрешением.
В чересстрочном GIF сначала записываются строки 1, 5, 9 и т. д. Таким образом, загрузив 1/4 данных, пользователь будет иметь представление о целом изображении. Вторым проходом следуют строки 3, 7, 11, разрешение изображения в браузере ещё вдвое увеличивается. Наконец, третий проход передаёт все недостающие строки (2, 4, 6…). Таким образом, задолго до окончания загрузки файла пользователь может понять, что внутри и решить, стоит ли ждать полной загрузки изображения. Чересстрочная запись незначительно увеличивает размер файла, но это, как правило, оправдывается приобретаемым свойством.
Формат GIF поддерживает анимационные изображения. Фрагменты представляют собой последовательности нескольких статичных кадров, а также информацию о том, сколько времени каждый кадр будет показан на экране. Анимация может быть закольцована, тогда после последнего кадра будет вновь показан первый и так далее.
GIF первоначально был проприетарным форматом, однако срок его патентной защиты истёк.
PNG (portable network graphics) — растровый формат хранения графической информации, использующий сжатие без потерь. PNG был создан как для улучшения, так и для замены формата GIF графическим форматом, не требующим лицензии для использования. Обычно файлы формата PNG имеют расширение .PNG (.png).
Неофициально PNG расшифровывают как «PNG is Not GIF» («PNG — это не GIF») 
PNG произносится по-английски, как слово ping. 
JPEG (Joint Photographic Experts Group, по названию организации-разработчика) — один из популярных графических форматов, применяемый для хранения фотоизображений и подобных им изображений. Файлы, содержащие данные JPEG, обычно имеют расширения .jpeg, .jfif, .jpg, .JPG, или .JPE. Однако из них .jpg самое популярное расширение на всех платформах.
Алгоритм JPEG является алгоритмом сжатия данных с потерями.
При сохранении JPEG-файла можно указать степень качества, а значит и степень сжатия, которую обычно задают в некоторых условных единицах, например, от 1 до 100 или от 1 до 10. Большее число соответствует лучшему качеству, но меньшему сжатию, при этом увеличивается размер файла. Обыкновенно, разница в качестве между 90 и 100 на глаз уже практически не воспринимается.
Широкая поддержка формата JPEG в разнообразном ПО нередко приводит к кодированию в JPEG изображений, для того не предназначенных. Даже безо всякого выигрыша по степени сжатия в сравнении с правильно сделанными PNG или GIF, но с прискорбными последствиями для качества. Например, попытка записать в JPEG изображение, содержащее мелкие контрастные детали (особенно, цветные) приведёт к появлению характерных хорошо заметных артефактов даже при высокой «степени качества».
При сжатии изображение преобразуется из цветового пространства RGB в YCbCr (яркостное Y и два цветоразностных Cb = Y - B, Cr = Y - R). Для цветоразностных пространств можно за счет прореживания уменьшить размеры, это первый шаг сжатия. 
Далее, яростный компонент Y и отвечающие за цвет компоненты Cb и Cr разбиваются на блоки 8х8 пикселов. Каждый такой блок подвергается дискретному косинусному преобразованию (ДКП).  Коэффициенты ДКП затем квантуются по уровням. Высокочастотные коэффициенты подвергаются более сильному квантованию, чем низкочастотные. Это приводит к огрублению мелких деталей на изображении. Чем выше степень сжатия, тем более сильному квантованию подвергаются все коэффициенты.
JPEG 2000 (или jp2) — графический формат, который вместо дискретного косинусного преобразования, характерного для JPEG, использует технологию вейвлет-преобразования, основывающуюся на представлении сигнала в виде суперпозиции некоторых конечных базовых функций — волновых пакетов.
В результате такой компрессии изображение получается более гладким и чётким, а размер файла по сравнению с JPEG при одинаковом качестве уменьшается ещё на 30 %.
EXIF (Exchangeable Image File Format) — стандарт, позволяющий добавлять к изображению информацию, комментирующую его. Например, условия и способы его получения, авторство.  и др. Получил широкое распространение в связи с появлением цифровых фотокамер. Информация, записанная в этом формате, может использоваться как пользователем, так и различными устройствами, например, принтером.
Разработчик формата — Japan Electronics and Information Technology Association (JEITA). 
Пример. загрузки в контейнер PictureBox1 растровой картинки *.bmp с преобразованием ее в другие форматы  сжатия и отображения в PictureBox2. 
Пусть выбран тип JPEG с качество 5. При нажатии на кнопку Старт формируется результат – выводится картинка, а в поле результата прописывается тип картинки и размер файла. Тип результата (TIFF, GIF, PNG, JPEG), выбирается из выпадающего списка combobox1 с заголовком «Выбор формата».
При выборе JPEG дополнительно выбирается желаемое качество результата от 5 до 100 из выпадающего списка-диапазона NumericUpDown. заголовком «Качество».
 Картинка получилась со сжатием почти в 100 раз, но с плохим качеством. Изменим качество на 30 и повторим преобразование. Результат с хорошим качеством, но сжатие стало меньше, около 30 раз  (рис.12.10). 

Рис.12.10 – а) Сжатие картинки в 100 раз; б) сжатие в 30 раз

Итоги лекции. Изучили представление графики методами C#. Ознакомились с графическими редакторами и способами из задания. С помощью Windos Form.
Контрольные вопросы
Какие инструменты необходимы для рисования изображения?
На что указывает объект Graphics и как он работает?
Для чего используются объекты перо, перечислите их.
Для чего используются объекты кисть, перечислите их.
Метод DrawString, для чего используется, приведите пример.
Расскажите о методах рисования.
Расскажите о методах заливки.
Дайте пример рисования с помощью примитивов.
Какие действия выполняются в обработчике при рисовании графиков.
Форматы растровой графики перечислите, охарактеризуйте один из них по выбору.
Приведите пример работы с растровой графикой.